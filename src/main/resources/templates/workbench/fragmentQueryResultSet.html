<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
    <head lang="en" th:replace="base/header :: head">
        <title>Hanger</title>
    </head>
    <body>        
        <div class="container">
            <!--Fragment-->
            <div th:fragment="resultSet">
                <div th:if="${ errorMessage != null }">
                    <div class="alert alert-danger" role="alert">
                        <span th:text="${errorMessage}"></span>
                    </div>  
                </div> 

                <!--Table or graph selector-->
                <ul class="nav nav-pills pull-right" id="tabSelector">                    
                    <li class="active">
                        <a data-toggle="tab" href="#list">
                            <span class="glyphicon glyphicon-th-list" title="Table"></span>
                        </a>                                
                    </li>
                    <li >
                        <a data-toggle="tab" href="#graph">
                            <span class="glyphicon glyphicon-signal" title="Chart"></span>
                        </a>  
                    </li>
                </ul>

                <div th:if="${ errorMessage == null }">
                    <div class="tab-content">
                        <!--Table view-->
                        <div id="list" class="tab-pane fade active in">
                            <div class="row col-sm-12">
                                <table id="table" class="table table-hover space-top table-workbench-result">
                                    <thead> 
                                        <tr>
                                            <th 
                                                th:each="header: ${resultset.header}" 
                                                class="column-title" 
                                                th:text="${header}" 
                                                data-toggle="tooltip" 
                                                data-placement="top"
                                                th:title="${resultset.type.get(header)}"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="row: ${resultset.row}">
                                            <td th:each="column: ${row.column}" th:text="${column}" />
                                        </tr>
                                    </tbody>
                                </table>

                                <span class="pull-right" th:inline="text">Query time: [[${resultset.elapsedTime}]] ms</span>
                            </div>
                        </div>

                        <!--Graph view-->
                        <div id="graph" class="tab-pane fade in">
                            <div class="row col-sm-12">
                                <div class="row col-sm-3">
                                    <div class="form-group">
                                        <fieldset>
                                            <legend>Type</legend>
                                            <div>
                                                <input type="radio" id="type_bar" name="type" value="bar" checked="checked"/>
                                                <label class="checkbox-label" th:text="Bar" ></label>
                                            </div>

                                            <div>
                                                <input type="radio" id="type_line" name="type" value="line" />
                                                <label class="checkbox-label" th:text="Line"></label>
                                            </div>

                                            <div>
                                                <input type="radio" id="type_radar" name="type" value="pie" />
                                                <label class="checkbox-label" th:text="Pie"></label>
                                            </div>

                                            <div>
                                                <input type="radio" id="type_radar" name="type" value="radar" />
                                                <label class="checkbox-label" th:text="Radar"></label>
                                            </div>
                                        </fieldset>
                                    </div>


                                    <div class="form-group">
                                        <fieldset>
                                            <legend>Y Axis</legend>
                                            <div th:each="header: ${resultset.header}">
                                                <div th:if="${
                                                     #strings.contains(resultset.className.get(header),'String') 
                                                     || #strings.contains(resultset.className.get(header),'Date')
                                                     || #strings.contains(resultset.className.get(header),'Time')}">

                                                    <input type="radio" th:id="${'label_' + header}" th:value="${header}" name="label"/>
                                                    <label class="checkbox-label" th:text="${header + ' (' + resultset.type.get(header) + ')'}"></label>
                                                </div>
                                            </div>
                                        </fieldset>
                                    </div>

                                    <div class="form-group">
                                        <fieldset>
                                            <legend>X Axis</legend>
                                            <div th:each="header: ${resultset.header}">
                                                <div th:if="${
                                                     not #strings.contains(resultset.className.get(header),'String')
                                                     && not #strings.contains(resultset.className.get(header),'Date') 
                                                     && not #strings.contains(resultset.className.get(header),'Time')}">

                                                    <input type="checkbox" th:id="${'dataset_' + header}" th:value="${header}"/>
                                                    <label class="checkbox-label" th:text="${header + ' (' + resultset.type.get(header) + ') [SUM]'}"></label>
                                                </div>
                                            </div>
                                        </fieldset>
                                    </div>
                                </div>

                                <div class="row col-sm-9">
                                    <canvas th:id="workbenchChart" width="800" height="600"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <script th:inline="javascript">
                        /*<![CDATA[*/
                        var label = "";
                        var resultset = /*[[${resultset.toJSONObject()}]]*/ "";
                        var indexes = [];

                        //Graph context. 
                        var context = document.getElementById('workbenchChart');

                        //Graph type. 
                        var type = 'bar';

                        //Graph data.
                        var data = {
                            labels: [],
                            datasets: []
                        };

                        //Graph options.
                        var options = {
                            responsive: true,
                            scales: {
                                xAxes: [{
                                        gridLines: {
                                            display: false
                                        },
                                        ticks: {
                                            beginAtZero: true,
                                            fontColor: "#999999"
                                        }
                                    }],
                                yAxes: [{
                                        ticks: {
                                            beginAtZero: true,
                                            padding: 20
                                        }
                                    }]
                            },
                            plugins: {
                                colorschemes: {
                                    scheme: 'brewer.PastelTwo8'
                                },
                                datalabels: {
                                    font: {
                                        weight: 'bold'
                                    },
                                    formatter: function (value) {
                                        return Math.round(value * 100) / 100;
                                    }
                                }
                            },
                            layout: {
                                padding: {
                                    left: 10,
                                    right: 30,
                                    top: 30
                                }
                            }
                        };

                        //Chart instance. 
                        var chart = new Chart(context, {
                            type: type,
                            data: data,
                            options: options
                        });

                        /**
                         * Change chart type.
                         */
                        $("input[type=radio][name=type]").on('change', function () {
                            type = $(this).attr('value');

                            //Destroy a chart. 
                            chart.destroy();

                            //Chart instance with choosed type. 
                            chart = new Chart(context, {
                                type: type,
                                data: data,
                                options: options
                            });
                        });

                        /**
                         * Add chart label. 
                         */
                        $("input[type=radio][name=label]").on('change', function () {
                            let uniqueLabels = [];
                            let labels = resultset[$(this).attr('value')];

                            //Identifies the selected label.
                            label = $(this).attr('value');

                            //Identifies unique labels values.
                            labels.forEach((c) => {
                                if (!uniqueLabels.includes(c)) {
                                    uniqueLabels.push(c);
                                }
                            });

                            //Resets the dataset selection.
                            $(":checkbox").prop("checked", false);

                            //Resets chart dataset properties, values and indexes.
                            indexes.splice(0, indexes.length);
                            chart.data.datasets.splice(0, chart.data.datasets.length);
                            chart.data.labels = uniqueLabels;

                            //Updates chart label.                            
                            chart.update();
                        });

                        /**
                         * Add chart datasets. 
                         */
                        $(":checkbox").on('change', function () {
                            if ($(this).is(':checked')) {
                                let uniqueLabels = [];
                                let summarizedValues = [];
                                let labels = resultset[label];
                                let values = resultset[$(this).attr('value')];

                                //Sumarrizes resultset values. 
                                for (var i = 0; i < labels.length; i++) {
                                    if (!uniqueLabels.includes(labels[i])) {
                                        uniqueLabels.push(labels[i]);
                                        summarizedValues.push(parseFloat(values[i]));
                                    } else {
                                        summarizedValues[uniqueLabels.indexOf(labels[i])] += parseFloat(values[i]);
                                    }
                                }

                                //Identifies dataset position.
                                indexes.push($(this).attr('value'));

                                //Adds values to the chart dataset.
                                chart.data.datasets.push({
                                    label: $(this).attr('value'),
                                    data: summarizedValues,
                                    fill: false
                                });
                            } else {
                                var index = indexes.indexOf($(this).attr('value'));

                                //Removes a dataset from chart by position.
                                if (index > -1) {
                                    indexes.splice(index, 1);
                                    chart.data.datasets.splice(index, 1);
                                }
                            }

                            chart.update();
                        });
                        /*]]>*/
                    </script>
                </div>
            </div>       	
    </body>
</html>
