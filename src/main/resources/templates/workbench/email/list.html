<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
    <head lang="en" th:replace="base/header :: head">
        <title>Hanger</title>
    </head>
    <body>
        <th:block th:include="base/header :: navbar"></th:block>
        <div class="container-fluid main-content">
            <table>
                <tr>
                    <th>
                        <h3 class="page-title">E-mails</h3>
                    </th>
                    <th class="btn-action"> 
                        <a th:href="@{'/workbench/workbench/'}" title="Workbench">
                            <span class="glyphicon glyphicon-chevron-right"></span>
                        </a>
                    </th>
                </tr>            
            </table>

            <div th:if="${ errorMessage != null }" class="form-group">
                <div class="alert alert-danger" role="alert">
                    <span th:text="${errorMessage}"></span>
                </div>  
            </div>

            <fieldset>
                <table id="table_workbench_email" class="table table-hover">
                    <thead>
                        <tr>
                            <th style="width:3%">#</th>
                            <th>Recipient</th>
                            <th>External Recipient</th>
                            <th>Subject</th>
                            <th>Query</th>
                            <th>Connection</th>
                            <th>Created at</th>

                            <th style="width:1%" class="no-sort"></th>
                            <th style="width:1%" class="no-sort"></th>
                            <th style="width:1%" class="no-sort"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="query-row" th:each="workbenchEmail : ${workbenchEmailList}">
                            <td th:text="${workbenchEmail.id}">#</td>
                            <td th:text="*{ #lists.isEmpty(workbenchEmail.recipient) ? '' : #strings.arrayJoin(workbenchEmail.recipient, '; ') }"></td>
                            <td>
                                <span th:text="${#strings.length(workbenchEmail.externalRecipient) > 35 ? #strings.substring(workbenchEmail.externalRecipient,0,35) : workbenchEmail.externalRecipient}"></span>                                
                                <div class="btn-group" th:if="${#strings.length(workbenchEmail.externalRecipient) > 35}">
                                    <button class="dropdown-toggle close" data-toggle="dropdown">...</button>
                                    <ul class="dropdown-menu">                                                
                                        <li>
                                            <pre class="line-numbers">
                                                    <code class="language-none" th:text="${workbenchEmail.externalRecipient}"></code>
                                            </pre>
                                        </li>  
                                    </ul>
                                </div>
                                <a class="btn-copy" 
                                   href="javascript:;" 
                                   th:if="${not #lists.isEmpty(workbenchEmail.externalRecipient)}" 
                                   th:attr="data-clipboard-text=${workbenchEmail.externalRecipient}">
                                    <span class="glyphicon glyphicon-duplicate icon-copy" aria-hidden="true" title="copy"></span>
                                </a>                                
                            </td>
                            <td th:text="${workbenchEmail.subject}"></td>
                            <td>
                                <div class="btn-group" th:if="${not #lists.isEmpty(workbenchEmail.query)}">
                                    <button class="dropdown-toggle close" data-toggle="dropdown"><span class="caret"></span></button>
                                    <ul class="dropdown-menu">                                                
                                        <li>
                                            <pre class="line-numbers">
                                                    <code class="language-sql" th:text="${workbenchEmail.query}"></code>
                                            </pre>
                                        </li>  
                                    </ul>
                                </div>
                                <a class="btn-copy" href="javascript:;" th:attr="data-clipboard-text=${workbenchEmail.query}">
                                    <span class="glyphicon glyphicon-duplicate icon-copy" aria-hidden="true" title="copy"></span>
                                </a>
                            </td>
                            <td th:text="${workbenchEmail.connection.name}"></td>
                            <td th:text="${#dates.format(workbenchEmail.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
                            <td>
                                <button 
                                    type="button" 
                                    class="btn btn-generic btn-xs btn-send" 
                                    th:id="'send_' + ${workbenchEmail.id}" 
                                    th:value="${workbenchEmail.id}">
                                    <span class="glyphicon glyphicon-send" aria-hidden="true"></span> 
                                    Send
                                </button>
                            </td>
                            <td>
                                <button 
                                    type="button" 
                                    class="btn btn-generic btn-xs btn-edit" 
                                    th:id="'edit_' + ${workbenchEmail.id}" 
                                    th:value="${workbenchEmail.id}">
                                    <span class="glyphicon glyphicon-edit" aria-hidden="true"></span> 
                                    Edit
                                </button>
                            </td>
                            <td>
                                <a class="btn btn-xs btn-delete" 
                                   data-toggle="modal" 
                                   th:attr="data-target='#'+${workbenchEmail.id}" 
                                   href="">
                                    <span 
                                        class="glyphicon glyphicon-trash" 
                                        aria-hidden="true"></span> 
                                    Delete
                                </a>

                                <!-- Model delete -->
                                <div class="modal fade" 
                                     th:id="${workbenchEmail.id}" 
                                     tabindex="-1" role="dialog" 
                                     aria-labelledby="modalDelete">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <button type="button" 
                                                        class="close" 
                                                        data-dismiss="modal" 
                                                        aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                                <h4 class="modal-title" 
                                                    id="modalParentLabel">Delete</h4>
                                            </div>
                                            <div class="modal-body">
                                                <span th:inline="text">Are you sure you want to delete "[[${workbenchEmail.subject}]]"?</span>
                                            </div>
                                            <div class="modal-footer"> 
                                                <a th:href="@{'/email/delete/' + ${workbenchEmail.id}}" 
                                                   class="col-xs-5 col-sm-5 col-md-5 btn btn-default btn-sm">
                                                    Yes
                                                </a>
                                                <a class="col-xs-5 col-sm-5 col-md-5 btn btn-default btn-sm" 
                                                   data-dismiss="modal" 
                                                   aria-label="Close">
                                                    No
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </fieldset>

            <!--AJAX Parent modal --> 
            <div id="modalHolder"/>

            <center>
                <button id="modal_wait" type="button" class="btn btn-default btn-sm" style="display:none;">
                    <img th:src="@{'/images/ajax-loader.gif'}"></img>
                </button>
            </center>
        </div>
        <script th:inline="javascript">
            $(document).ready(function () {

                /**
                 * Set header CSRF Token.
                 * @returns {undefined}
                 */
                $.ajaxSetup({
                    headers: {'X-CSRF-Token': $('#_csrf').attr('content')}
                });

                $(".btn-edit").click(function () {
                    var url = /*[[@{/email/modal/edit/}]]*/ "/email/modal/edit/";
                    var id = $(this).val();

                    $.ajax({
                        type: "POST",
                        url: url + id,
                        contentType: "text/html",
                        timeout: 1000000,
                        success: function (result) {
                            $("#modalHolder").html(result);
                            $("#modalEmail").modal({
                                backdrop: 'static'
                            });
                            $('.selectpicker').selectpicker();
                        },
                        error: function (e) {
                            alert("Fail loading query resultset: "
                                    + e.statusText);
                        }
                    });
                });

                $(".btn-send").click(function () {
                    var url = /*[[@{/email/email/}]]*/ "/email/email/";
                    var btnSend = $(this);
                    var id = btnSend.val();

                    $.ajax({
                        type: "GET",
                        url: url + id,
                        contentType: "text/html",
                        timeout: 1000000,
                        beforeSend: function () {
                            btnSend.prop("disabled", true);
                            toastr.info('Sending ...');
                        },
                        success: function () {
                            toastr.success('Email sent successfully!');
                            btnSend.prop("disabled", false);
                        },
                        error: function (e) {
                            alert("Fail loading query resultset: "
                                    + e.statusText);
                            btnSend.prop("disabled", false);
                        }
                    });
                });
            });
        </script>
    </body>
</html> 